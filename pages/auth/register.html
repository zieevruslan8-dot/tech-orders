// Функция перенаправления по роли
function redirectByRole(role) {
    switch(role) {
        case 'client':
            window.location.href = "../client/dashboard.html";
            break;
        case 'driver':
            window.location.href = "../driver/dashboard.html";
            break;
        case 'fleet':
            window.location.href = "../fleet/dashboard.html";
            break;
        default:
            window.location.href = "../client/dashboard.html";
    }
}

document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const firstName = document.getElementById('firstName').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;
    
    try {
        // 1. РЕГИСТРАЦИЯ (теперь без подтверждения email)
        const { data: authData, error: authError } = await supabase.auth.signUp({
            email: email,
            password: password,
            options: {
                data: {
                    first_name: firstName,
                    role: role
                }
                // НЕТ emailConfirm: false - просто не включаем
            }
        });
        
        if (authError) {
            // Если пользователь уже существует
            if (authError.message.includes('already registered') || 
                authError.message.includes('User already registered')) {
                
                // Пробуем войти с этими данными
                const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (signInError) {
                    alert('Пользователь уже существует, но пароль неверный.');
                    return;
                }
                
                // Сохраняем данные
                localStorage.setItem('user_role', role);
                localStorage.setItem('user_email', email);
                localStorage.setItem('user_name', firstName);
                
                // Перенаправляем
                redirectByRole(role);
                return;
            }
            
            alert('Ошибка регистрации: ' + authError.message);
            return;
        }
        
        // 2. СРАЗУ ВХОДИМ ПОСЛЕ РЕГИСТРАЦИИ
        const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });
        
        if (signInError) {
            // Если всё ещё ошибка (маловероятно, но на всякий случай)
            alert('Регистрация успешна, но вход не удался: ' + signInError.message + '\n\nПопробуйте войти вручную.');
            window.location.href = "login.html";
            return;
        }
        
        // 3. СОЗДАЁМ ПРОФИЛЬ
        if (signInData.user) {
            const { error: profileError } = await supabase
                .from('profiles')
                .upsert({
                    id: signInData.user.id,
                    email: email,
                    first_name: firstName,
                    role: role,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                });
            
            if (profileError) {
                console.warn('Предупреждение (профиль):', profileError);
                // Не прерываем процесс, это не критично
            }
        }
        
        // 4. СОХРАНЯЕМ ДАННЫЕ И ПЕРЕНАПРАВЛЯЕМ
        localStorage.setItem('user_role', role);
        localStorage.setItem('user_email', email);
        localStorage.setItem('user_name', firstName);
        
        // Показываем сообщение и перенаправляем
        alert(`✅ Регистрация успешна!\nДобро пожаловать, ${firstName}!`);
        redirectByRole(role);
        
    } catch (error) {
        alert('Ошибка: ' + error.message);
        console.error('Полная ошибка:', error);
    }
});

// Проверяем, если уже авторизован
document.addEventListener('DOMContentLoaded', async () => {
    const { data } = await supabase.auth.getSession();
    if (data.session) {
        // Если уже вошёл, перенаправляем
        const savedRole = localStorage.getItem('user_role') || 'client';
        redirectByRole(savedRole);
    }
});
